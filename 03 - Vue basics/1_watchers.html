<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue watchers</title>
</head>

<body>
    <div id="app">

        <select v-model="selectedUserId">
            <option value="">Select a user</option>
            <option v-for="user in users" v-bind:value="user.id">
                {{ user.name }}
            </option>
        </select>

        <p>Selected user id: {{ selectedUserId }}</p>

        <hr>

        <p>Posts made by the selected user:</p>

        <article v-for="article in posts">
            <h5>{{ article.title }}</h5>
            <p>{{ article.description }}</p>
            <a href="#">Read more</a>
        </article>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        // Destructing createApp and ref from Vue object
        const { createApp, ref, onMounted, watch } = Vue

        const app = createApp({
            setup() {
                // downloading users from the api to generate select options
                const users = ref([])
                const fetchUsers = async () => {
                    const response = await fetch('https://jsonplaceholder.typicode.com/users')
                    const data = await response.json()

                    users.value = data
                }

                onMounted(() => {
                    fetchUsers()

                    // fetchPostsByUserId(selectedUserId.value)
                })

                const selectedUserId = ref(1)

                const selectedUser = (id) => {
                    return users.value
                        .map(user => ({
                            id: user.id,
                            name: user.name,
                            email: user.email,
                        }))
                        .find(user => user.id === id)
                }

                // posts array to store the posts published by the selected user
                const posts = ref([])

                // download posts published by the given userId
                const fetchPostsByUserId = async (userId) => {
                    const response = await fetch(`https://jsonplaceholder.typicode.com/posts?userId=${userId}`)
                    const data = await response.json()

                    posts.value = data
                }

                // watch for changes in the seletedUserId
                // - newVal is the new value of the selectedUserId
                // - oldVal is the old value of the selectedUserId
                // - immediate: true to fetch posts immediately when the component is mounted
                watch(selectedUserId, (newVal, oldVal) => {
                    console.log(newVal, oldVal)
                    fetchPostsByUserId(newVal)
                }, { immediate: true })

                return {
                    users,
                    selectedUserId,

                    selectedUser,
                    //
                    posts,
                }
            }
        }).mount('#app')
    </script>
</body>

</html>
